<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT-Finpro Control Center</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        /* TEMA GELAP (DARK MODE) */
        body { font-family: 'Segoe UI', sans-serif; background-color: #121212; color: #e0e0e0; text-align: center; margin: 0; padding: 20px; }
        h1 { color: #00e676; letter-spacing: 1.5px; margin-bottom: 5px; }
        .status { font-size: 0.9rem; margin-bottom: 20px; font-weight: bold; }
        .connected { color: #00e676; }
        .disconnected { color: #ff3d00; }

        /* GRID LAYOUT */
        .container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            max-width: 800px;
            margin: 0 auto;
        }

        /* CARD STYLE */
        .card {
            background: #1e1e1e;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            border: 1px solid #333;
        }
        .card h2 { margin-top: 0; color: #bdbdbd; font-size: 1.1rem; border-bottom: 1px solid #333; padding-bottom: 10px; }
        
        /* VALUE DISPLAY */
        .big-value { font-size: 2.5rem; font-weight: 700; color: #fff; }
        .unit { font-size: 0.8rem; color: #888; text-transform: uppercase; }
        
        /* BATTERY BAR */
        .battery-shell {
            width: 100%; height: 20px; background: #333; margin: 10px 0;
            border-radius: 10px; overflow: hidden; position: relative;
        }
        .battery-level {
            height: 100%; width: 0%; 
            background: linear-gradient(90deg, #d32f2f, #fbc02d, #388e3c);
            transition: width 0.5s ease;
        }

        /* SLIDER CONTROL */
        input[type=range] {
            width: 100%; -webkit-appearance: none; background: transparent; margin: 15px 0;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%;
            background: #00e676; cursor: pointer; margin-top: -10px; box-shadow: 0 0 5px rgba(0,230,118,0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #555; border-radius: 2px;
        }
        
        /* BUTTONS */
        .btn-stop {
            background-color: #d32f2f; color: white; border: none; padding: 12px;
            border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; 
            font-size: 1rem; transition: background 0.2s;
        }
        .btn-stop:hover { background-color: #b71c1c; }
        .btn-stop:active { transform: scale(0.98); }

    </style>
</head>
<body>

    <h1>üèéÔ∏è IoT-Finpro RC Console</h1>
    <div id="connectionStatus" class="status disconnected">Status: Disconnected ‚ùå</div>

    <div class="container">
        <div class="card">
            <h2>üîã MONITOR DAYA</h2>
            <div class="big-value"><span id="valVolt">0.00</span> <span class="unit">Volt</span></div>
            <div class="battery-shell">
                <div id="barVolt" class="battery-level"></div>
            </div>
            <p style="font-size: 0.75rem; color: #777;">Safe Range: 6.0V - 8.4V</p>
        </div>

        <div class="card">
            <h2>üöÄ STATUS REAL-TIME</h2>
            <div style="display: flex; justify-content: space-around; align-items: center;">
                <div>
                    <div class="unit">Speed (PWM)</div>
                    <div id="valSpeed" class="big-value">0</div>
                </div>
                <div style="width: 1px; height: 50px; background: #333;"></div>
                <div>
                    <div class="unit">Steering (¬∞)</div>
                    <div id="valAngle" class="big-value">90</div>
                </div>
            </div>
        </div>

        <div class="card" style="grid-column: 1 / -1;">
            <h2>üéÆ KONTROL WEB (ALTERNATIVE)</h2>
            
            <label style="color: #aaa; font-size: 0.9rem;">Throttle (Maju/Mundur)</label>
            <input type="range" id="sliderSpeed" min="-255" max="255" value="0" oninput="sendSpeed(this.value)">
            <p style="margin-top: -10px; font-size: 0.8rem; color: #888;">PWM: <span id="dispSpeed" style="color: #fff;">0</span></p>

            <label style="color: #aaa; font-size: 0.9rem;">Steering (Kiri/Kanan)</label>
            <input type="range" id="sliderSteer" min="50" max="130" value="90" oninput="sendSteer(this.value)">
            <p style="margin-top: -10px; font-size: 0.8rem; color: #888;">Angle: <span id="dispSteer" style="color: #fff;">90</span></p>

            <button class="btn-stop" onclick="emergencyStop()">üõë REM DARURAT (EMERGENCY STOP)</button>
        </div>
    </div>

    <script>
        // --- KONFIGURASI MQTT ---
        // PENTING: Jika di HOSTING (Vercel), ubah port jadi 8884 dan useSSL: true
        // PENTING: Jika LOCAL (Laptop), pakai port 8000 dan useSSL: false
        const broker = "broker.hivemq.com";
        const port = 8000; // WebSocket Port (Local)
        const clientID = "WebDash_IoTFinpro_" + parseInt(Math.random() * 100000);
        
        // Topik (Sinkron dengan ESP32)
        const topic_rx_volt  = "ui/iotfinpro/telemetry/voltage";
        const topic_rx_speed = "ui/iotfinpro/telemetry/speed";
        const topic_rx_angle = "ui/iotfinpro/telemetry/steering";
        
        const topic_tx_speed = "ui/iotfinpro/control/speed";
        const topic_tx_steer = "ui/iotfinpro/control/steer";

        // Inisialisasi Client Paho
        const client = new Paho.MQTT.Client(broker, port, clientID);

        // Event Handlers
        client.onConnectionLost = onConnectionLost;
        client.onMessageArrived = onMessageArrived;

        // Mulai Koneksi
        console.log("Connecting to " + broker + ":" + port);
        client.connect({onSuccess:onConnect, useSSL:false});

        function onConnect() {
            console.log("Connected!");
            document.getElementById("connectionStatus").innerHTML = "Status: Connected ‚úÖ (Siap Monitor)";
            document.getElementById("connectionStatus").className = "status connected";

            // Subscribe Telemetri
            client.subscribe("ui/iotfinpro/telemetry/#");
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.log("Connection Lost: " + responseObject.errorMessage);
                document.getElementById("connectionStatus").innerHTML = "Status: Disconnected ‚ùå (Cek Internet)";
                document.getElementById("connectionStatus").className = "status disconnected";
            }
        }

        // --- MENERIMA DATA DARI MOBIL (RX) ---
        function onMessageArrived(message) {
            const topic = message.destinationName;
            const payload = message.payloadString;

            if (topic === topic_rx_volt) {
                let v = parseFloat(payload);
                document.getElementById("valVolt").innerText = v.toFixed(2);
                
                // Animasi Bar Baterai (Range 6.0V - 8.4V)
                let percent = ((v - 6.0) / (8.4 - 6.0)) * 100;
                if (percent < 0) percent = 0; 
                if (percent > 100) percent = 100;
                document.getElementById("barVolt").style.width = percent + "%";
            }
            else if (topic === topic_rx_speed) {
                document.getElementById("valSpeed").innerText = payload;
            }
            else if (topic === topic_rx_angle) {
                document.getElementById("valAngle").innerText = payload;
            }
        }

        // --- MENGIRIM PERINTAH KE MOBIL (TX) ---
        function sendSpeed(val) {
            document.getElementById("dispSpeed").innerText = val;
            let message = new Paho.MQTT.Message(val);
            message.destinationName = topic_tx_speed;
            client.send(message);
        }

        function sendSteer(val) {
            document.getElementById("dispSteer").innerText = val;
            let message = new Paho.MQTT.Message(val);
            message.destinationName = topic_tx_steer;
            client.send(message);
        }

        function emergencyStop() {
            // Reset Slider ke 0
            document.getElementById("sliderSpeed").value = 0;
            document.getElementById("dispSpeed").innerText = "0";
            // Kirim Perintah Stop
            let message = new Paho.MQTT.Message("0");
            message.destinationName = topic_tx_speed;
            client.send(message);
        }
    </script>
</body>
</html>